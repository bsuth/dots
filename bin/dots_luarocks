#!/bin/bash

set -e

declare -a LUA_VERSIONS=(
  "5.1"
  "5.2"
  "5.3"
  "5.4"
)

declare -a LUAROCKS_PACKAGES=(
  argparse
  luafilesystem
  lua-cjson
  busted
  inspect
)

if ! [[ -d $HOME/extern/luarocks ]]; then
  mkdir -p "$HOME/extern"
  git clone git://github.com/luarocks/luarocks.git "$HOME/extern/luarocks"
fi

cd "$HOME/extern/luarocks"

for LUA_VERSION in ${LUA_VERSIONS[@]}; do
  SKIP=1

  for PACKAGE in ${LUAROCKS_PACKAGES[@]}; do
    if ! luarocks --local --lua-version="$LUA_VERSION" show "$PACKAGE" >/dev/null 2>/dev/null; then
      SKIP=0
      break
    fi
  done

  if [[ $SKIP == 1 ]]; then
    echo -e "Skipping luarocks $LUA_VERSION"
    continue
  fi

  ./configure --lua-version="$LUA_VERSION"
  make
  sudo make install

  for PACKAGE in ${LUAROCKS_PACKAGES[@]}; do
    if ! luarocks --local --lua-version="$LUA_VERSION" show "$PACKAGE"; then
      luarocks --local --lua-version="$LUA_VERSION" install "$PACKAGE"
    fi
  done
done

cd -
